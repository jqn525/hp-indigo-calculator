<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Inventory - SFU</title>
    <meta name="description" content="Search inventory items">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- SFU Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#CC0633">
</head>
<body>
    <!-- Authentication Guard -->
    <script src="js/auth-guard.js"></script>
    
    <div class="container-fluid px-3 py-4">
        <!-- Header -->
        <div class="d-flex align-items-center mb-4">
            <button onclick="window.history.back()" class="btn btn-link text-decoration-none p-0 me-3">
                <span style="font-size: 1.5rem;">←</span>
            </button>
            <h1 class="h4 mb-0">Search Inventory</h1>
        </div>

        <!-- Search Bar -->
        <div class="mb-4">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search by name, SKU, category, or location..." autofocus>
                <button class="btn btn-primary" type="button" id="searchBtn">
                    Search
                </button>
            </div>
            <div class="form-text">Search across all inventory items and categories</div>
        </div>

        <!-- Results Summary -->
        <div id="resultsSummary" class="mb-3" style="display: none;">
            <span class="text-muted">Showing <span id="resultsCount">0</span> results</span>
        </div>

        <!-- Search Results -->
        <div id="searchResults" class="search-results">
            <!-- Initial state - show categories -->
            <div id="browseCategories">
                <h5 class="mb-3">Browse by Category</h5>
                <div class="category-grid">
                    <!-- This will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Search results will appear here -->
            <div id="resultsContainer" style="display: none;">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>

        <!-- No Results -->
        <div id="noResults" class="text-center py-5" style="display: none;">
            <div class="text-muted">
                <div style="font-size: 3rem; font-weight: bold;">SEARCH</div>
                <h4 class="mt-3">No Items Found</h4>
                <p>Try adjusting your search terms or browse by category above.</p>
            </div>
        </div>
    </div>

    <!-- Request Modal (same as in request.html) -->
    <div class="request-modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Item</h3>
                <button class="btn-close" onclick="closeRequestModal()" aria-label="Close">×</button>
            </div>
            
            <div id="modalBody">
                <div class="mb-3">
                    <strong id="itemName"></strong><br>
                    <small class="text-muted">
                        SKU: <span id="itemSku"></span><br>
                        Location: <span id="itemLocation"></span>
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" id="quantity" class="form-control" min="1" value="1" required>
                    <small class="text-muted">Unit: <span id="itemUnit"></span></small>
                </div>
                
                <div class="form-group">
                    <label for="itemNotes" class="form-label">Notes (optional)</label>
                    <textarea id="itemNotes" class="form-control" rows="2" placeholder="Any special instructions..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeRequestModal()">Cancel</button>
                <button class="btn-submit" onclick="submitRequest()">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- App Scripts -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script type="module" src="js/inventoryStructure.js"></script>
    
    <script type="module">
        import { inventoryStructure, searchInventoryItems, getAllInventoryItems } from './js/inventoryStructure.js';
        
        let currentItem = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            displayBrowseCategories();
            
            // Check for URL search parameter
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            if (query) {
                document.getElementById('searchInput').value = query;
                performSearch(query);
            }
        });

        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            searchInput.addEventListener('input', function(e) {
                if (e.target.value.trim() === '') {
                    showBrowseMode();
                }
            });
            
            searchBtn.addEventListener('click', performSearch);
        }

        function displayBrowseCategories() {
            const grid = document.querySelector('.category-grid');
            grid.innerHTML = '';
            
            Object.entries(inventoryStructure).forEach(([categoryName, category]) => {
                const card = document.createElement('div');
                card.className = 'action-card mb-3';
                card.style.minHeight = '80px';
                card.style.padding = '1rem';
                
                card.innerHTML = `
                    <div class="action-icon" style="font-size: 1.5rem;">${category.icon || 'CAT'}</div>
                    <div class="action-label" style="font-size: 0.85rem;">${categoryName}</div>
                `;
                
                card.onclick = () => searchByCategory(categoryName);
                grid.appendChild(card);
            });
        }

        function performSearch(query = null) {
            const searchQuery = query || document.getElementById('searchInput').value.trim();
            
            if (!searchQuery) {
                showBrowseMode();
                return;
            }
            
            const results = searchInventoryItems(searchQuery);
            displaySearchResults(results, searchQuery);
        }

        function searchByCategory(categoryName) {
            const allItems = getAllInventoryItems();
            const results = allItems.filter(item => 
                item.category.includes(categoryName)
            );
            
            document.getElementById('searchInput').value = categoryName;
            displaySearchResults(results, categoryName);
        }

        function displaySearchResults(results, query) {
            const browseDiv = document.getElementById('browseCategories');
            const resultsDiv = document.getElementById('resultsContainer');
            const summaryDiv = document.getElementById('resultsSummary');
            const noResultsDiv = document.getElementById('noResults');
            const resultsCount = document.getElementById('resultsCount');
            
            // Hide browse mode
            browseDiv.style.display = 'none';
            
            if (results.length === 0) {
                resultsDiv.style.display = 'none';
                summaryDiv.style.display = 'none';
                noResultsDiv.style.display = 'block';
                return;
            }
            
            // Show results summary
            resultsCount.textContent = results.length;
            summaryDiv.style.display = 'block';
            noResultsDiv.style.display = 'none';
            
            // Display results
            resultsDiv.innerHTML = '';
            
            results.forEach(item => {
                const itemCard = createSearchResultCard(item, query);
                resultsDiv.appendChild(itemCard);
            });
            
            resultsDiv.style.display = 'block';
        }

        function createSearchResultCard(item, query) {
            const card = document.createElement('div');
            card.className = 'card mb-3';
            
            // Highlight search terms
            const highlightText = (text, query) => {
                if (!query) return text;
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            };
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${highlightText(item.name, query)}</h6>
                            <div class="text-muted small mb-2">
                                <strong>SKU:</strong> ${highlightText(item.sku, query)}<br>
                                <strong>Location:</strong> ${highlightText(item.location, query)}<br>
                                <strong>Category:</strong> ${highlightText(item.category, query)}<br>
                                <strong>Unit:</strong> ${item.unit}
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm ms-3" onclick="openRequestModal('${item.id}')">
                            Request
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function showBrowseMode() {
            document.getElementById('browseCategories').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('resultsSummary').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
        }

        function openRequestModal(itemId) {
            const allItems = getAllInventoryItems();
            const item = allItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            currentItem = item;
            
            // Update modal content
            document.getElementById('itemName').textContent = item.name;
            document.getElementById('itemSku').textContent = item.sku;
            document.getElementById('itemLocation').textContent = item.location;
            document.getElementById('itemUnit').textContent = item.unit;
            
            // Reset form
            document.getElementById('quantity').value = '1';
            document.getElementById('itemNotes').value = '';
            
            // Show modal
            document.getElementById('requestModal').classList.add('show');
        }

        function closeRequestModal() {
            document.getElementById('requestModal').classList.remove('show');
            currentItem = null;
        }

        async function submitRequest() {
            if (!currentItem) return;
            
            const quantity = parseInt(document.getElementById('quantity').value);
            const notes = document.getElementById('itemNotes').value.trim();
            
            if (!quantity || quantity < 1) {
                alert('Please enter a valid quantity');
                return;
            }
            
            const requestItem = {
                id: currentItem.id,
                name: currentItem.name,
                sku: currentItem.sku,
                quantity: quantity,
                unit: currentItem.unit,
                location: currentItem.location,
                category: currentItem.category || '',
                notes: notes
            };
            
            try {
                const submitBtn = document.querySelector('.btn-submit');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                
                await window.inventoryApp.submitRequest([requestItem], '');
                
                alert('Request submitted successfully!');
                closeRequestModal();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                alert('Failed to submit request. Please try again.');
            } finally {
                const submitBtn = document.querySelector('.btn-submit');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
            }
        }

        // Make functions globally available
        window.openRequestModal = openRequestModal;
        window.closeRequestModal = closeRequestModal;
        window.submitRequest = submitRequest;
    </script>
    
    <style>
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        mark {
            background-color: #fff3cd;
            padding: 0.1em 0.2em;
            border-radius: 0.2em;
        }
        
        .search-result-item {
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</body>
</html>