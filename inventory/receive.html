<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receive Inventory - SFU</title>
    <meta name="description" content="Process received inventory items">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- SFU Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#CC0633">
</head>
<body>
    <!-- Authentication Guard -->
    <script src="js/auth-guard.js"></script>
    
    <div class="container-fluid px-3 py-4">
        <!-- Header -->
        <div class="d-flex align-items-center mb-4">
            <button onclick="window.history.back()" class="btn btn-link text-decoration-none p-0 me-3">
                <span style="font-size: 1.5rem;">←</span>
            </button>
            <h1 class="h4 mb-0">Receive Inventory</h1>
        </div>

        <!-- Info Alert -->
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Process Approved Requests</strong><br>
            This page shows approved inventory requests that are ready to be received and fulfilled.
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading approved requests...</p>
        </div>

        <!-- Approved Requests -->
        <div id="requestsList" class="requests-list" style="display: none;">
            <!-- This will be populated by JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <div class="text-muted">
                <div style="font-size: 3rem; font-weight: bold;">RCV</div>
                <h4 class="mt-3">No Pending Deliveries</h4>
                <p>All approved requests have been fulfilled or there are no approved requests waiting for delivery.</p>
            </div>
        </div>
    </div>

    <!-- Fulfill Modal -->
    <div class="request-modal" id="fulfillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Mark as Fulfilled</h3>
                <button class="btn-close" onclick="closeFulfillModal()" aria-label="Close">×</button>
            </div>
            
            <div id="modalBody">
                <!-- This will be populated with request details -->
            </div>
            
            <div class="form-group">
                <label for="fulfillmentNotes" class="form-label">Fulfillment Notes (optional)</label>
                <textarea id="fulfillmentNotes" class="form-control" rows="3" placeholder="Any notes about the delivery or fulfillment..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeFulfillModal()">Cancel</button>
                <button class="btn-submit" onclick="markAsFulfilled()">Mark as Fulfilled</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <!-- App Scripts -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        let approvedRequests = [];
        let currentRequest = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadApprovedRequests();
        });

        async function loadApprovedRequests() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('requestsList').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                
                // Wait for app to initialize
                if (!window.inventoryApp.initialized) {
                    await window.inventoryApp.init();
                }
                
                // Get all approved requests (admin function, but we'll filter for approved only)
                const allRequests = await window.inventoryApp.getAllRequests();
                approvedRequests = allRequests.filter(req => req.status === 'approved');
                
                displayRequests();
                
            } catch (error) {
                console.error('Error loading approved requests:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load requests. Please try refreshing the page.
                    </div>
                `;
            }
        }

        function displayRequests() {
            document.getElementById('loadingState').style.display = 'none';
            
            if (approvedRequests.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('requestsList').style.display = 'none';
                return;
            }
            
            const listContainer = document.getElementById('requestsList');
            listContainer.innerHTML = '';
            
            // Sort by created_at desc
            approvedRequests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            approvedRequests.forEach(request => {
                const requestCard = createRequestCard(request);
                listContainer.appendChild(requestCard);
            });
            
            document.getElementById('requestsList').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'card mb-3';
            
            const totalItems = request.items.reduce((sum, item) => sum + parseInt(item.quantity), 0);
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            Request #${request.id.slice(-8)}
                            <span class="badge bg-success ms-2">Approved</span>
                        </h6>
                        <small class="text-muted">
                            ${window.inventoryApp.formatDate(request.processed_at)}
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="fw-bold text-primary">${request.items.length}</div>
                                <small class="text-muted">Item Types</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-primary">${totalItems}</div>
                                <small class="text-muted">Total Units</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-muted">${request.user_name || request.user_email.split('@')[0]}</div>
                                <small class="text-muted">Requested by</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Items to Deliver:</strong>
                        <div class="mt-2">
                            ${request.items.map(item => `
                                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                    <div>
                                        <div class="fw-medium">${item.name}</div>
                                        <small class="text-muted">SKU: ${item.sku} | Location: ${item.location}</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-primary">${item.quantity} ${item.unit}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${request.notes ? `
                        <div class="mb-3">
                            <strong>Request Notes:</strong>
                            <div class="text-muted small">${request.notes}</div>
                        </div>
                    ` : ''}
                    
                    ${request.admin_notes ? `
                        <div class="mb-3">
                            <strong>Admin Notes:</strong>
                            <div class="text-success small">${request.admin_notes}</div>
                        </div>
                    ` : ''}
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="openFulfillModal('${request.id}')">
                            Mark as Fulfilled
                        </button>
                        <button class="btn btn-outline-primary" onclick="printDeliverySlip('${request.id}')">
                            Print Delivery Slip
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function openFulfillModal(requestId) {
            const request = approvedRequests.find(r => r.id === requestId);
            if (!request) return;
            
            currentRequest = request;
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div class="mb-3">
                    <strong>Request #${request.id.slice(-8)}</strong>
                    <div class="text-muted small">
                        Requested by: ${request.user_name || request.user_email}<br>
                        Approved: ${window.inventoryApp.formatDate(request.processed_at)}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Items Being Fulfilled:</strong>
                    <div class="mt-2">
                        ${request.items.map(item => `
                            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 bg-light">
                                <div>
                                    <div class="fw-medium">${item.name}</div>
                                    <small class="text-muted">SKU: ${item.sku}</small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">${item.quantity} ${item.unit}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <small>
                        <strong>Confirm:</strong> All items listed above have been delivered to the requesting staff member.
                    </small>
                </div>
            `;
            
            document.getElementById('fulfillmentNotes').value = '';
            document.getElementById('fulfillModal').classList.add('show');
        }

        function closeFulfillModal() {
            document.getElementById('fulfillModal').classList.remove('show');
            currentRequest = null;
        }

        async function markAsFulfilled() {
            if (!currentRequest) return;
            
            const notes = document.getElementById('fulfillmentNotes').value.trim();
            const submitBtn = document.querySelector('#fulfillModal .btn-submit');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                // Update the admin notes to include fulfillment info
                const fulfillmentNote = notes 
                    ? `${currentRequest.admin_notes || ''}\n\nFulfilled: ${notes}`.trim()
                    : `${currentRequest.admin_notes || ''}\n\nFulfilled on ${new Date().toLocaleDateString()}`.trim();
                
                await window.inventoryApp.updateRequestStatus(currentRequest.id, 'fulfilled', fulfillmentNote);
                
                // Remove from the list and refresh display
                approvedRequests = approvedRequests.filter(r => r.id !== currentRequest.id);
                displayRequests();
                closeFulfillModal();
                
                alert('Request marked as fulfilled successfully!');
                
            } catch (error) {
                console.error('Error marking as fulfilled:', error);
                alert('Failed to mark as fulfilled. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Mark as Fulfilled';
            }
        }

        function printDeliverySlip(requestId) {
            const request = approvedRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Create a simple print-friendly delivery slip
            const printWindow = window.open('', '_blank');
            const totalItems = request.items.reduce((sum, item) => sum + parseInt(item.quantity), 0);
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Delivery Slip - Request #${request.id.slice(-8)}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #CC0633; padding-bottom: 10px; margin-bottom: 20px; }
                        .info { margin-bottom: 20px; }
                        .items { border: 1px solid #ddd; }
                        .items th, .items td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
                        .items th { background-color: #f8f9fa; font-weight: bold; }
                        .footer { margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>SFU Document Solutions</h2>
                        <h3>Inventory Delivery Slip</h3>
                    </div>
                    
                    <div class="info">
                        <p><strong>Request #:</strong> ${request.id.slice(-8)}</p>
                        <p><strong>Requested by:</strong> ${request.user_name || request.user_email}</p>
                        <p><strong>Approved:</strong> ${window.inventoryApp.formatDate(request.processed_at)}</p>
                        <p><strong>Print Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <table class="items" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>SKU</th>
                                <th>Quantity</th>
                                <th>Location</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${request.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.sku}</td>
                                    <td>${item.quantity} ${item.unit}</td>
                                    <td>${item.location}</td>
                                    <td>${item.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>Total Items:</strong> ${request.items.length} types, ${totalItems} units</p>
                        ${request.notes ? `<p><strong>Special Instructions:</strong> ${request.notes}</p>` : ''}
                        ${request.admin_notes ? `<p><strong>Admin Notes:</strong> ${request.admin_notes}</p>` : ''}
                        
                        <br>
                        <p>_________________________________</p>
                        <p>Delivered by: _________________ Date: _________</p>
                        <br>
                        <p>_________________________________</p>
                        <p>Received by: __________________ Date: _________</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()">Print This Slip</button>
                        <button onclick="window.close()">Close</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
        }

        // Make functions globally available
        window.openFulfillModal = openFulfillModal;
        window.closeFulfillModal = closeFulfillModal;
        window.markAsFulfilled = markAsFulfilled;
        window.printDeliverySlip = printDeliverySlip;
    </script>
</body>
</html>